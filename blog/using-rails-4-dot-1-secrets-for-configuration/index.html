
<!DOCTYPE HTML>
<html xmlns:og="http://ogp.me/ns#" xmlns:fb="http://ogp.me/ns/fb#">
<head>
	<meta charset="utf-8">
	
	
	
  
  
  <title>Using Rails 4.1 Secrets for Configuration | Brandon Hilkert</title>
	<meta name="author" content="Brandon Hilkert">

	<meta name="description" content="Rails 4.1 introduced a new secrets file that can easily be used for app configuration">
	

  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimal-ui">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:creator" content="@brandonhilkert">
  <meta name="twitter:title" content="Using Rails 4.1 Secrets for Configuration">
  <meta name="twitter:description" content="Rails 4.1 introduced a new secrets file that can easily be used for app configuration">
  <meta name="twitter:image" content="http://brandonhilkert.com/images/brandon-hilkert.jpg">

  <meta property="og:title" content="Using Rails 4.1 Secrets for Configuration | Brandon Hilkert"/>
  <meta property="og:description" content="Rails 4.1 introduced a new secrets file that can easily be used for app configuration">
  <meta property="og:url" content="http://brandonhilkert.com/blog/using-rails-4-dot-1-secrets-for-configuration/"/>
  <meta property="og:image" content="http://brandonhilkert.com/images/brandon-hilkert-large.jpg" />
  <meta property="og:site_name" content="Brandon Hilkert's Blog"/>
  <meta property="og:type" content="article"/>
  <meta property="fb:profile_id" content="1472745932"/>

	<link href="/atom.xml" rel="alternate" title="Using Rails 4.1 Secrets for Configuration | Brandon Hilkert" type="application/atom+xml">
	<link rel="canonical" href="http://brandonhilkert.com/blog/using-rails-4-dot-1-secrets-for-configuration/">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
  <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <link href="http://fonts.googleapis.com/css?family=Open+Sans:300" rel="stylesheet" type="text/css">
  <link rel="author" href="https://plus.google.com/u/0/116002935339410846674" />
  <script src="/javascripts/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
</head>


<body>
	<div class="container">
		<div class="left-col">
			<header id="header"><div class="profilepic">
  <a href="/">
    <img src="/images/brandon-hilkert.jpg" width="80" height="80" alt="Brandon Hilkert Profile Picture" />
  </a>
</div>
<hgroup>
  <h1><a href="/">Brandon Hilkert</a></h1>
  
</hgroup>

<nav id="main-nav">
  <ul class="main-navigation">
    <li><a href="/about">About</a></li>
    <li><a href="/">Blog</a></li>
    <li><a href="/newsletter">Newsletter</a></li>
    <li>
      <a href="/courses/build-a-ruby-gem">Courses</a>
    </li>
    <li>
      <div class="new-label">New</div>
      <a href="/books/build-a-ruby-gem">Books</a>
    </li>
  </ul>
  <section class="aboutme">
    <p>
      Hi. I'm Brandon.
      <br />
      I'm a technologist in PA.
    </p>
  </section>
</nav>

<nav id="sub-nav">
	<div class="social">
		
		
		
		<a class="twitter" href="https://twitter.com/brandonhilkert" title="Twitter">Twitter</a>
		
		
		<a class="github" href="https://github.com/brandonhilkert" title="GitHub">GitHub</a>
		
		
		<a class="linkedin" href="http://www.linkedin.com/in/brandonhilkert">LinkedIn</a>
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
</nav>

<aside class="popular-posts">
  <h4>Popular Posts</h4>
<ul>
  <li>
    <a href="/blog/using-rails-4-dot-1-secrets-for-configuration/">Using Rails 4.1 Secrets for Config</a>
  </li>
  <li>
    <a href="/blog/7-reasons-why-im-sticking-with-minitest-and-fixtures-in-rails">7 Reasons I'm sticking with Minitest</a>
  </li>
  <li>
    <a href="/blog/page-specific-javascript-in-rails/">Page-specific Javascript in Rails</a>
  </li>
  <li>
    <a href="/blog/managing-login-passwords-for-capybara-with-minitest-and-rails-fixtures/">Minitest Helper Includes</a>
  </li>
  <li>
    <a href="/blog/ruby-gem-configuration-patterns/">Ruby Gem Configuration Patterns</a>
  </li>
  <!-- <li> -->
  <!--   <a href="/blog/how&#45;to&#45;build&#45;a&#45;rails&#45;engine/">How to Build a Rails Engine</a> -->
  <!-- </li> -->
  <!-- <li> -->
  <!--   <a href="/blog/why&#45;i&#45;wrote&#45;the&#45;sucker&#45;punch&#45;gem/">Why I Wrote the Sucker Punch Gem</a> -->
  <!-- </li> -->
  <!-- <li> -->
  <!--   <a href="/blog/setting&#45;up&#45;a&#45;cloudfront&#45;cdn&#45;for&#45;rails/">Setup a Cloudfront CDN for Rails</a> -->
  <!-- </li> -->
  <!-- <li> -->
  <!--   <a href="/blog/3&#45;ways&#45;to&#45;get&#45;started&#45;contributing&#45;to&#45;open&#45;source/">Get Started with Open Source</a> -->
  <!-- </li> -->
</ul>


</aside>

</header>
		</div>
		<div class="mid-col">
			
				

			
			<div class="mid-col-container">
				<div id="content" class="inner"><article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  
  <div class="date">








  


<time datetime="2014-06-10T20:03:00-04:00" data-updated="true" itemprop="datePublished">June 10<span>th</span>, 2014</time></div>
	<h1 class="title" itemprop="name">Using Rails 4.1 Secrets for Configuration</h1>
  <div class="tags">


	<a class='category' href='/blog/categories/config/'>config</a>, <a class='category' href='/blog/categories/env/'>env</a>, <a class='category' href='/blog/categories/rails/'>rails</a>, <a class='category' href='/blog/categories/ruby/'>ruby</a>


</div>
	<div class="entry-content" itemprop="articleBody"><p>I previously wrote about how I handle <a href="/blog/flexible-rails-environment-configuration/">environment configuration in Rails</a>. Along with solutions like the <a href="https://github.com/bkeepers/dotenv">dotenv gem</a>, it relies on entirely on environment variables.</p>

<p>One of the highlighted features of Rails 4.1 was the <a href="http://guides.rubyonrails.org/4_1_release_notes.html#config-secrets-yml"><code>config/secrets.yml</code></a> file. By default, this file contains the <code>secret_key_base</code> and defers to the ENV variable of the same name in the production environment. Even though <code>secret_key_base</code> isn’t typically referenced explicitly in an application, I was curious if I could use the <code>config/secrets.yml</code> file in place of previously documented configuration solution.</p>

<!--more-->


<p>After a little digging, it turns out that it works perfectly. A valid question is whether the variables are better referenced through the <code>Rails.application</code> hash, but that’s probably more a preference and use-case dependent decision. Either way, we’ll explore the solution below.</p>

<h2>The Question</h2>

<p>Below is a default <code>config/secrets.yml</code> file generated from a Rails 4.1 app. As you can see, both the development and test environments rely on statically set values, where the production environment relies on environment variables being set on the system. The latter is perfect for platforms like <a href="https://www.heroku.com">Heroku</a>, and just as easy if you manage your own systems on EC2 or similar infrastructure.</p>

<figure class='code'><pre><code>development:
  secret_key_base: 9ac2d0ad8ebcc312090e99d745006d3cf8

test:
  secret_key_base: a1580ad61ccb6ac60f9f256948cf63d6e20

# Do not keep production secrets in the repository,
# instead read values from the environment.
production:
  secret_key_base: &lt;%= ENV["SECRET_KEY_BASE"] %&gt;</code></pre></figure>


<p>Notice how ERB is processed in the file. This gives us the opportunity to use Ruby to generate random strings, dates, or anything else that can be expressed through code.</p>

<p>So can we use it for other configuration values in the application?</p>

<h2>The Solution</h2>

<p>In order to figure out where the output of the parsed secrets file was stored, I pulled the latest Rails changes and went code diving.</p>

<p>The first thing I did was search “secrets”. The first group of results were mostly comments related to the processing of <code>secret_key_base</code> and where it could be found. After combing through a few more results, I came across the <code>Rails::Application</code> class.</p>

<p>A static array at the top of the file seemed to hold some values for the application as shown below:</p>

<figure class='code'><pre><code>INITIAL_VARIABLES = [:config, :railties, :routes_reloader, :reloaders,
                        :routes, :helpers, :app_env_config, :secrets] # :nodoc:
</code></pre></figure>


<p>Looks like we’re on the right track. Going further down the file leads us to the getter:</p>

<figure class='code'><pre><code>def secrets #:nodoc:
  @secrets ||= begin
    secrets = ActiveSupport::OrderedOptions.new
    yaml = config.paths["config/secrets"].first

    if File.exist?(yaml)
      require "erb"
      all_secrets = YAML.load(ERB.new(IO.read(yaml)).result) || {}
      env_secrets = all_secrets[Rails.env]
      secrets.merge!(env_secrets.symbolize_keys) if env_secrets
    end

    # Fallback to config.secret_key_base if secrets.secret_key_base isn't set
    secrets.secret_key_base ||= config.secret_key_base

    secrets
  end
end</code></pre></figure>


<p>As you can see, the file path <code>config/secrets</code> is referenced as the <code>yaml</code> source:</p>

<figure class='code'><pre><code>yaml = config.paths["config/secrets"].first</code></pre></figure>


<p>and the result of reading the file is sent through ERB and YAML:</p>

<figure class='code'><pre><code>all_secrets = YAML.load(ERB.new(IO.read(yaml)).result) || {}</code></pre></figure>


<p>The environment group is parsed:</p>

<figure class='code'><pre><code>env_secrets = all_secrets[Rails.env]</code></pre></figure>


<p>The result of the output is returned, leaving us with a hash of options based on the environment group. With a little luck we should be able to query the application from the console and get the configuration values.</p>

<figure class='code'><pre><code>irb(main):001:0&gt; Rails.application.secrets.class
=&gt; ActiveSupport::OrderedOptions
irb(main):002:0&gt; Rails.application.secrets
=&gt; {:secret_key_base=&gt;"9ac2d0ad8ebcc312090e99d745006d3cf8"}
irb(main):003:0&gt; Rails.application.secrets.secret_key_base
=&gt; "a1580ad61ccb6ac60f9f256948cf63d6e20"</code></pre></figure>


<p>That’s great news because it means we can put other values in this file and reference them throughout our application using the parent hash <code>Rails.application.secrets</code>.</p>

<p>For example, let’s assume we need to configuration Pusher URL again. We could add it to the <code>secrets.yml</code> file like so:</p>

<figure class='code'><pre><code>development:
  secret_key_base: 9ac2d0ad8ebcc312090e99d745006d3cf8
  pusher_url: http://asdfa@api.pusherapp.com

test:
  secret_key_base: a1580ad61ccb6ac60f9f256948cf63d6e20

# Do not keep production secrets in the repository,
# instead read values from the environment.
production:
  secret_key_base: &lt;%= ENV["SECRET_KEY_BASE"] %&gt;
  pusher_url: &lt;%= ENV["PUSHER_URL"] %&gt;</code></pre></figure>


<p>Now within our application we can set the Pusher URL within the initializer using the secret value:</p>

<figure class='code'><pre><code># config/initializers/pusher.rb
Pusher.url = Rails.application.secrets.pusher_url</code></pre></figure>


<h2>Summary</h2>

<p>I feel like my previous solution has the potential to be replaced with the secrets file. I plan to try it out in an upcoming application and see if it’s as easy to manage as it seems.</p>

<p>Note that by default, the <code>secrets.yml</code> file is NOT ignored by git. If you plan to include passwords or other sensitive data in the file, be sure to add it to your <code>.gitignore</code>.</p>
</div>
  
    <div class="funnel" data-funnel="f18c90f3cf"></div>
<script>
  var _foq = _foq || [];
  var _fo = _fo || {};
  _fo.app = '7b08e58282';

  (function() {
    var s = document.createElement("script");
    s.type = 'text/javascript';
    s.async = true;
    s.src = '//d2q3ph8vu140pa.cloudfront.net/assets/fo.js';
    document.getElementsByTagName('body')[0].appendChild(s);
  })();

  _foq.push(["load"]);
</script>

  


</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">

    
    <a href="http://bufferapp.com/add" class="buffer-add-button" data-count="horizontal" data-via="brandonhilkert" >Buffer</a>
    <script type="text/javascript" src="http://static.bufferapp.com/js/button.js"></script>
    

    
    <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
    

    
    <a class="addthis_button_tweet"></a>
    

    
    <script type="IN/Share" data-counter="right"></script>
    

    
    <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    

	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>



  <section id="comment">
    <h1 class="title">Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>
			</div>
      
        <footer id="footer" class="inner"><ul>
  <li>
    <h4>Categories</h4>
    <ul>
      <li><a href="/blog/categories/ruby/">Ruby</a></li>
      <li><a href="/blog/categories/rails/">Rails</a></li>
      <li><a href="/blog/categories/open-source/">Open Source</a></li>
      <li><a href="/blog/categories/marketing/">Marketing</a></li>
      <li><a href="/blog/categories/email-course/">Email Course</a></li>
      <li><a href="/blog/categories/book/">Book</a></li>
    </ul>
  </li>
  <li>
    <h4>Popular Posts</h4>
<ul>
  <li>
    <a href="/blog/using-rails-4-dot-1-secrets-for-configuration/">Using Rails 4.1 Secrets for Config</a>
  </li>
  <li>
    <a href="/blog/7-reasons-why-im-sticking-with-minitest-and-fixtures-in-rails">7 Reasons I'm sticking with Minitest</a>
  </li>
  <li>
    <a href="/blog/page-specific-javascript-in-rails/">Page-specific Javascript in Rails</a>
  </li>
  <li>
    <a href="/blog/managing-login-passwords-for-capybara-with-minitest-and-rails-fixtures/">Minitest Helper Includes</a>
  </li>
  <li>
    <a href="/blog/ruby-gem-configuration-patterns/">Ruby Gem Configuration Patterns</a>
  </li>
  <!-- <li> -->
  <!--   <a href="/blog/how&#45;to&#45;build&#45;a&#45;rails&#45;engine/">How to Build a Rails Engine</a> -->
  <!-- </li> -->
  <!-- <li> -->
  <!--   <a href="/blog/why&#45;i&#45;wrote&#45;the&#45;sucker&#45;punch&#45;gem/">Why I Wrote the Sucker Punch Gem</a> -->
  <!-- </li> -->
  <!-- <li> -->
  <!--   <a href="/blog/setting&#45;up&#45;a&#45;cloudfront&#45;cdn&#45;for&#45;rails/">Setup a Cloudfront CDN for Rails</a> -->
  <!-- </li> -->
  <!-- <li> -->
  <!--   <a href="/blog/3&#45;ways&#45;to&#45;get&#45;started&#45;contributing&#45;to&#45;open&#45;source/">Get Started with Open Source</a> -->
  <!-- </li> -->
</ul>


  </li>
</ul>
<br class="clear" />
<p>
  &copy; 2014 Big Blue Media, LLC. All rights reserved.
</p>
</footer>
        <script src="/javascripts/slash.js"></script>


<script type="text/javascript">
      var disqus_shortname = 'brandonhilkert';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://brandonhilkert.com/blog/using-rails-4-dot-1-secrets-for-configuration/';
        var disqus_url = 'http://brandonhilkert.com/blog/using-rails-4-dot-1-secrets-for-configuration/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



      
		</div>
	</div>
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-24469169-1', 'brandonhilkert.com');
  ga('require', 'linkid', 'linkid.js');
  ga('require', 'displayfeatures');
  ga('send', 'pageview');
</script>

  <link href="/stylesheets/widget.css" media="screen, projection" rel="stylesheet" type="text/css">
<link href="/stylesheets/animate.min.css" media="screen, projection" rel="stylesheet" type="text/css">

<div class="subscribe-widget animated bounceInUp">
  <div class="title">
    Ruby/Rails Newsletter - FREE!
  </div>
  <div class="description">
    <p>
      Join <strong>2,500+</strong> other Rubyists and take your skills to the next level!
    </p>
    <p>
      Ruby and Rails tips delivered to your inbox 2-4 times per month. No obligation and absolutely
      no spam. Unsubscribe at any time.
    </p>

    <p>
      Enter your email below to get started today:
    </p>
  </div>
  <div class="close">&#10005;</div>
  <div class="open">&#8593;</div>

  <form action="http://brandonhilkert.us7.list-manage2.com/subscribe/post?u=34ccc3aa2135746d0231c9420&amp;id=167c8d9713" method="post" target="_blank" novalidate>
    <input type="email" value="" name="EMAIL" placeholder="your@email.com" required>
    <input type="hidden" name="LOCATION" id="LOCATION" value="Using Rails 4.1 Secrets for Configuration" />
    <input type="hidden" name="PRODUCT" id="PRODUCT" value="newsletter" />
    <input type="submit" value="Send me articles like this!" name="subscribe" id="mc-embedded-subscribe">
  </form>
</div>



<script src="/javascripts/widget.js"></script>


</body>
</html>
