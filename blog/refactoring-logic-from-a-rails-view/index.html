
<!DOCTYPE HTML>
<html xmlns:og="http://ogp.me/ns#" xmlns:fb="http://ogp.me/ns/fb#">
<head>
	<meta charset="utf-8">
	
	
	
  
  
  <title>Refactoring Logic from a Rails View | Brandon Hilkert</title>
	<meta name="author" content="Brandon Hilkert">

	<meta name="description" content="Rails views are supposed to be logic-less, but sometimes starting with basic logic is simplest way to get started.">
	

  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimal-ui">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:creator" content="@brandonhilkert">
  <meta name="twitter:title" content="Refactoring Logic from a Rails View">
  <meta name="twitter:description" content="Rails views are supposed to be logic-less, but sometimes starting with basic logic is simplest way to get started.">
  <meta name="twitter:image" content="http://brandonhilkert.com/images/brandon-hilkert.jpg">

  <meta property="og:title" content="Refactoring Logic from a Rails View | Brandon Hilkert"/>
  <meta property="og:description" content="Rails views are supposed to be logic-less, but sometimes starting with basic logic is simplest way to get started.">
  <meta property="og:url" content="http://brandonhilkert.com/blog/refactoring-logic-from-a-rails-view/"/>
  <meta property="og:image" content="http://brandonhilkert.com/images/brandon-hilkert-large.jpg" />
  <meta property="og:site_name" content="Brandon Hilkert's Blog"/>
  <meta property="og:type" content="article"/>
  <meta property="fb:profile_id" content="1472745932"/>

	<link href="/atom.xml" rel="alternate" title="Refactoring Logic from a Rails View | Brandon Hilkert" type="application/atom+xml">
	<link rel="canonical" href="http://brandonhilkert.com/blog/refactoring-logic-from-a-rails-view/">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
  <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <link href="http://fonts.googleapis.com/css?family=Open+Sans:300" rel="stylesheet" type="text/css">
  <link rel="author" href="https://plus.google.com/u/0/116002935339410846674" />
  <script src="/javascripts/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
</head>


<body>
	<div class="container">
		<div class="left-col">
			<header id="header"><div class="profilepic">
  <a href="/">
    <img src="/images/brandon-hilkert.jpg" width="80" height="80" alt="Brandon Hilkert Profile Picture" />
  </a>
</div>
<hgroup>
  <h1><a href="/">Brandon Hilkert</a></h1>
  
</hgroup>

<nav id="main-nav">
  <ul class="main-navigation">
    <li><a href="/about">About</a></li>
    <li><a href="/">Blog</a></li>
    <li><a href="/newsletter">Newsletter</a></li>
    <li>
      <a href="/courses/build-a-ruby-gem">Courses</a>
    </li>
    <li>
      <div class="new-label">New</div>
      <a href="/books/build-a-ruby-gem">Books</a>
    </li>
    <li>
      <a href="/tools">Tools</a>
    </li>
  </ul>
</nav>

<nav id="sub-nav">
	<div class="social">
		
		
		
		<a class="twitter" href="https://twitter.com/brandonhilkert" title="Twitter">Twitter</a>
		
		
		<a class="github" href="https://github.com/brandonhilkert" title="GitHub">GitHub</a>
		
		
		<a class="linkedin" href="http://www.linkedin.com/in/brandonhilkert">LinkedIn</a>
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
</nav>

<aside class="popular-posts">
  <h4>Popular Posts</h4>
<ul>
  <li>
    <a href="/blog/using-rails-4-dot-1-secrets-for-configuration/">Using Rails 4.1 Secrets for Config</a>
  </li>
  <li>
    <a href="/blog/7-reasons-why-im-sticking-with-minitest-and-fixtures-in-rails">7 Reasons I'm sticking with Minitest</a>
  </li>
  <li>
    <a href="/blog/page-specific-javascript-in-rails/">Page-specific Javascript in Rails</a>
  </li>
  <li>
    <a href="/blog/managing-login-passwords-for-capybara-with-minitest-and-rails-fixtures/">Minitest Helper Includes</a>
  </li>
  <li>
    <a href="/blog/ruby-gem-configuration-patterns/">Ruby Gem Configuration Patterns</a>
  </li>
  <!-- <li> -->
  <!--   <a href="/blog/how&#45;to&#45;build&#45;a&#45;rails&#45;engine/">How to Build a Rails Engine</a> -->
  <!-- </li> -->
  <!-- <li> -->
  <!--   <a href="/blog/why&#45;i&#45;wrote&#45;the&#45;sucker&#45;punch&#45;gem/">Why I Wrote the Sucker Punch Gem</a> -->
  <!-- </li> -->
  <!-- <li> -->
  <!--   <a href="/blog/setting&#45;up&#45;a&#45;cloudfront&#45;cdn&#45;for&#45;rails/">Setup a Cloudfront CDN for Rails</a> -->
  <!-- </li> -->
  <!-- <li> -->
  <!--   <a href="/blog/3&#45;ways&#45;to&#45;get&#45;started&#45;contributing&#45;to&#45;open&#45;source/">Get Started with Open Source</a> -->
  <!-- </li> -->
</ul>


</aside>

</header>
		</div>
		<div class="mid-col">
			
				

			
			<div class="mid-col-container">
				<div id="content" class="inner"><article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  
  <div class="date">








  


<time datetime="2014-07-30T06:03:00-04:00" data-updated="true" itemprop="datePublished">July 30<span>th</span>, 2014</time></div>
	<h1 class="title" itemprop="name">Refactoring Logic From a Rails View</h1>
  <div class="tags">


	<a class='category' href='/blog/categories/rails/'>rails</a>, <a class='category' href='/blog/categories/refactor/'>refactor</a>, <a class='category' href='/blog/categories/ruby/'>ruby</a>, <a class='category' href='/blog/categories/view/'>view</a>


</div>
	<div class="entry-content" itemprop="articleBody"><p>It’s generally known that leaving any kind of logic in a Rails view is bad news, both for debugging and your own sanity. Rails views can be cumbersome to test and leave a lot to be desired when it comes to debugging.</p>

<!--more-->


<p>I recently went through the process of refactoring a Rails view that included logic. The end result was an isolated <a href="http://blog.jayfields.com/2007/10/ruby-poro.html">PORO</a> that was easily integrated with the controller/view.</p>

<h2>Background</h2>

<p>The app I’m currently working on is a greenfield app with vague specs, at best. I don’t mention this to fault anyone, but more to illustrate a point. Not all greenfield projects have well-defined specs.</p>

<p>In this particular case, the stakeholders were somewhat unsure of what the interface should look like. Together, we tossed around a number of ideas, ultimately leading to a few options. Only once an iteration of the UI was available, would we have a clear picture of whether it <em>felt right</em>.</p>

<h2>The Problem</h2>

<p>I implemented the first option in the most crude way I could think of. Unfortunately, that way involved putting logic in the view. I know, I know — I can hear it now, <em>”C’mon Brandon, everyone knows you shouldn’t do this!”</em>. Here’s the thing — I knew it too.</p>

<p>Here’s what I ended up with:</p>

<figure class='code'><pre><code># controller

def people
  @week_of = params[:week_of] || Checkin::Week.recent(current_company).first.beginning
  @people = current_user.reports
end

# view

&lt;% @people.each do |person| %&gt;
  &lt;% checkin = person.checkin_for(@week_of) %&gt;
  &lt;tr&gt;
    &lt;td&gt;
      &lt;%= profile_picture person %&gt;
      &lt;%= person %&gt;
    &lt;/td&gt;

    &lt;td&gt;
      &lt;%= checkin_status(checkin) %&gt;
    &lt;/td&gt;
  &lt;/tr&gt;
&lt;% end %&gt;</code></pre></figure>


<p>For each iteration of <code>@people</code>, I looked up the check-in for that particular week from the model:</p>

<figure class='code'><pre><code>def checkin_for(week_of)
  Checkin.find_by(user_id: id, week_of: week_of)
end</code></pre></figure>


<p>This crosses concerns, blurs responsibility — all the things that bad Rails app are made of. But I was doing this knowing it would either be entirely ripped out (we’d change the UI altogether), or refactored to something better.</p>

<p><em>Note: I could’ve just saved myself one step and never made the method in the model. For some reason, that made me feel better about it at the time. *shrugs*</em></p>

<p>So I added a Github issue and went on my way…</p>

<p><img class="center" src="/images/view-refactor/gh-issue.png" title="&#34;Github issue to refactor Rails view&#34;" alt="&#34;Github issue to refactor Rails view&#34;"></p>

<h2>The Solution</h2>

<p>With a few minor tweaks, this implementation of the functionality and UI was adequate. So as time allowed, I jumped back in to untangling the mess I created.</p>

<p>The biggest variable in the display of a <code>Checkin</code> was the week (a date field corresponding to the beginning of that particular week). Once the date was known, I could look for a <code>Checkin</code> for each user in my visibility, see if it existed, and if not, return a stand-in object to represent a non-completed check-in.</p>

<p>I removed the model method:</p>

<figure class='code'><pre><code>def checkin_for(week_of)
  Checkin.find_by(user_id: id, week_of: week_of)
end</code></pre></figure>


<p>and the line in the view largely responsible for the mess:</p>

<figure class='code'><pre><code>&lt;% checkin = person.checkin_for(@week_of) %&gt;</code></pre></figure>


<p>I went back to the controller and initialized a new object that would allow me to iterate over a list of check-ins:</p>

<figure class='code'><pre><code>def people
  @week_of = params[:week_of] || Checkin::Week.recent(current_company).first.beginning
  @reports = Checkin::Reports.new(current_user, @week_of)
end</code></pre></figure>


<p>Let’s dig in to the new <code>Checkin::Reports</code> class…</p>

<figure class='code'><pre><code>class Checkin
  class Reports
    def initialize(user, week_of)
      @user, @week_of = user, week_of
    end

    def checkins
      reports.map { |person|
        Checkin.find_or_initialize_by(user_id: person.id, week_of: week_of)
      }
    end

    private

    attr_reader :user, :week_of

    def reports
      user.reports
    end
  end
end</code></pre></figure>


<p>I instantiate with the user and week, similar to what the <code>checkin_for</code> model method did above.</p>

<p>The only relatively interesting part of this class is that it’s using <code>find_or_intialize_by</code>. It turns out that the view didn’t care if the object was <code>nil</code>, or just a non-persisted <code>Checkin</code> object. All it did was interrogate certain attributes of the object, and guard against the argument being <code>nil</code>. From that perspective, we’ve improved our code even more because now instead of supplying nil to the helper, we are actually supplying it with a newly instantiated <code>Checkin</code> with some default attributes.</p>

<p>This means that our <code>checkin_status</code> helper, went from:</p>

<figure class='code'><pre><code>def checkin_status(checkin)
  if checkin && checkin.completed_at?
    fa_icon("check-square-o", class: "green") + " Submitted #{local_time checkin.completed_at, format: :short_month_day }".html_safe
  else
    fa_icon("warning", class: "yellow") + " Not completed"
  end
end</code></pre></figure>


<p>to:</p>

<figure class='code'><pre><code>def checkin_status(checkin)
  if checkin.completed_at?
    fa_icon("check-square-o", class: "green") + " Submitted #{local_time checkin.completed_at, format: :short_month_day }".html_safe
  else
    fa_icon("warning", class: "yellow") + " Not completed"
  end
end</code></pre></figure>


<p>It’s a subtle change (removing the check <code>if checkin</code> from the first conditional), but one that’s less susceptible to bizarre edge cases. And clearer — It’s reasonable to expect that by calling the first argument <code>checkin</code>, <strong>the variable should be a <code>Checkin</code></strong>, and not sometimes <code>nil</code>.</p>

<p>Returning back to the view…using the new <code>@reports</code> variable, we no longer have to query during each iteration:</p>

<figure class='code'><pre><code>&lt;% @reports.checkins.each do |checkin| %&gt;
  &lt;tr&gt;
    &lt;td&gt;
      &lt;%= profile_picture checkin.user %&gt;
      &lt;%= checkin.user %&gt;
    &lt;/td&gt;

    &lt;td&gt;
      &lt;%= checkin_status(checkin) %&gt;
    &lt;/td&gt;
  &lt;/tr&gt;
&lt;% end %&gt;</code></pre></figure>


<p>Tests pass, and we’re in a much better place than we were before.</p>

<h2>Summary</h2>

<p>I’ve seen a lot of people make notes for themselves to improve areas of their application and either never get the opportunity to go back and do so, or get so far removed from the mess, they forget about how bad it was in the first place. The approach I took above by making a note for myself worked because <strong>I knew</strong> I would go back to it. It’s possible this may not work for everyone.</p>

<p>If it takes more than just making a Github issue for your and your team, find what works. The important part is that the refactor takes place, in whatever way convenient for you.</p>

<p>The idea of not putting logic in a Rails view is well regarded as a best practice. Don’t think that just because I did it above, I’m advocating that it’s ok. To me, it’s only acceptable if you go back at a later time (soonish…) and clean it up.</p>

<p>Leaving little bits of bad practice sprinkled all of your app is heading of for a bad time. As <a href="http://sandimetz.com/">Sandi Metz</a> says, <a href="http://www.confreaks.com/presenters/211-sandi-metz">“go ahead, make a mess”</a>. Just be sure to come back and clean it up.</p>
</div>
  
    <div class="funnel" data-funnel="f18c90f3cf"></div>
<script>
  var _foq = _foq || [];
  var _fo = _fo || {};
  _fo.app = '7b08e58282';

  (function() {
    var s = document.createElement("script");
    s.type = 'text/javascript';
    s.async = true;
    s.src = '//d2q3ph8vu140pa.cloudfront.net/assets/fo.js';
    document.getElementsByTagName('body')[0].appendChild(s);
  })();

  _foq.push(["load"]);
</script>

  


</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">

    
    <a href="http://bufferapp.com/add" class="buffer-add-button" data-count="horizontal" data-via="brandonhilkert" >Buffer</a>
    <script type="text/javascript" src="http://static.bufferapp.com/js/button.js"></script>
    

    
    <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
    

    
    <a class="addthis_button_tweet"></a>
    

    
    <script type="IN/Share" data-counter="right"></script>
    

    
    <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    

	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>



  <section id="comment">
    <h1 class="title">Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>
			</div>
      
        <footer id="footer" class="inner"><ul>
  <li>
    <h4>Categories</h4>
    <ul>
      <li><a href="/blog/categories/ruby/">Ruby</a></li>
      <li><a href="/blog/categories/rails/">Rails</a></li>
      <li><a href="/blog/categories/open-source/">Open Source</a></li>
      <li><a href="/blog/categories/marketing/">Marketing</a></li>
      <li><a href="/blog/categories/email-course/">Email Course</a></li>
      <li><a href="/blog/categories/book/">Book</a></li>
    </ul>
  </li>
  <li>
    <h4>Popular Posts</h4>
<ul>
  <li>
    <a href="/blog/using-rails-4-dot-1-secrets-for-configuration/">Using Rails 4.1 Secrets for Config</a>
  </li>
  <li>
    <a href="/blog/7-reasons-why-im-sticking-with-minitest-and-fixtures-in-rails">7 Reasons I'm sticking with Minitest</a>
  </li>
  <li>
    <a href="/blog/page-specific-javascript-in-rails/">Page-specific Javascript in Rails</a>
  </li>
  <li>
    <a href="/blog/managing-login-passwords-for-capybara-with-minitest-and-rails-fixtures/">Minitest Helper Includes</a>
  </li>
  <li>
    <a href="/blog/ruby-gem-configuration-patterns/">Ruby Gem Configuration Patterns</a>
  </li>
  <!-- <li> -->
  <!--   <a href="/blog/how&#45;to&#45;build&#45;a&#45;rails&#45;engine/">How to Build a Rails Engine</a> -->
  <!-- </li> -->
  <!-- <li> -->
  <!--   <a href="/blog/why&#45;i&#45;wrote&#45;the&#45;sucker&#45;punch&#45;gem/">Why I Wrote the Sucker Punch Gem</a> -->
  <!-- </li> -->
  <!-- <li> -->
  <!--   <a href="/blog/setting&#45;up&#45;a&#45;cloudfront&#45;cdn&#45;for&#45;rails/">Setup a Cloudfront CDN for Rails</a> -->
  <!-- </li> -->
  <!-- <li> -->
  <!--   <a href="/blog/3&#45;ways&#45;to&#45;get&#45;started&#45;contributing&#45;to&#45;open&#45;source/">Get Started with Open Source</a> -->
  <!-- </li> -->
</ul>


  </li>
</ul>
<br class="clear" />
<p>
  &copy; 2015 Big Blue Media, LLC. All rights reserved.
</p>
</footer>
        <script src="/javascripts/slash.js"></script>


<script type="text/javascript">
      var disqus_shortname = 'brandonhilkert';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://brandonhilkert.com/blog/refactoring-logic-from-a-rails-view/';
        var disqus_url = 'http://brandonhilkert.com/blog/refactoring-logic-from-a-rails-view/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



      
		</div>
	</div>
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-24469169-1', 'brandonhilkert.com');
  ga('require', 'linkid', 'linkid.js');
  ga('require', 'displayfeatures');
  ga('send', 'pageview');
</script>

  <link href="/stylesheets/widget.css" media="screen, projection" rel="stylesheet" type="text/css">
<link href="/stylesheets/animate.min.css" media="screen, projection" rel="stylesheet" type="text/css">

<div class="subscribe-widget animated bounceInUp">
  <div class="title">
    Ruby/Rails Newsletter - FREE!
  </div>
  <div class="description">
    <p>
      Join <strong>2,500+</strong> other Rubyists and take your skills to the next level!
    </p>
    <p>
      Ruby and Rails tips delivered to your inbox 2-4 times per month. No obligation and absolutely
      no spam. Unsubscribe at any time.
    </p>

    <p>
      Enter your email below to get started today:
    </p>
  </div>
  <div class="close">&#10005;</div>
  <div class="open">&#8593;</div>

  <form action="http://brandonhilkert.us7.list-manage2.com/subscribe/post?u=34ccc3aa2135746d0231c9420&amp;id=167c8d9713" method="post" target="_blank" novalidate>
    <input type="email" value="" name="EMAIL" placeholder="your@email.com" required>
    <input type="hidden" name="LOCATION" id="LOCATION" value="Refactoring Logic from a Rails View" />
    <input type="hidden" name="PRODUCT" id="PRODUCT" value="newsletter" />
    <input type="submit" value="Send me articles like this!" name="subscribe" id="mc-embedded-subscribe">
  </form>
</div>



<script src="/javascripts/widget.js"></script>


</body>
</html>
