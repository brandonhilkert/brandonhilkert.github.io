
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Why I Wrote sucker_punch | Brandon Hilkert</title>
	<meta name="author" content="Brandon Hilkert">

	
	<meta name="description" content="October 20th, 2013 Why I Wrote Sucker_punch open source, programming, ruby One of the simplest and most common application of
background processing is sending &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="/atom.xml" rel="alternate" title="Brandon Hilkert" type="application/atom+xml">
	
	<link rel="canonical" href="http://brandonhilkert.com/blog/why-i-wrote-sucker-punch/">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
  <link href='http://fonts.googleapis.com/css?family=Sorts+Mill+Goudy:400,400italic' rel='stylesheet' type='text/css'>
  <link href="http://fonts.googleapis.com/css?family=Open+Sans:300" rel="stylesheet" type="text/css">
</head>


<body>
	<div class="container">
		<div class="left-col">
			<header id="header"><div class="profilepic">
  <a href="/">
    <img src="/images/brandon-hilkert.jpg" width="80" height="80" alt="Brandon Hilkert Profile Picture" />
  </a>
</div>
<hgroup>
  <h1><a href="/">Brandon Hilkert</a></h1>
  
</hgroup>

<nav id="main-nav">
  <ul class="main-navigation">
    <li><a href="/about">About</a></li>
    <li><a href="/">Blog</a></li>
    <li><a href="http://railsmasterclass.com">Workshop</a></li>
  </ul>
  <section class="aboutme">
    <p>
      Hi. I'm Brandon.
      <br />
      I'm a technology entrepreneur in PA.
    </p>
  </section>
</nav>

<nav id="sub-nav">
	<div class="social">
		
		
		
		<a class="twitter" href="http://twitter.com/brandonhilkert" title="Twitter">Twitter</a>
		
		
		<a class="github" href="https://github.com/brandonhilkert" title="GitHub">GitHub</a>
		
		
		
		
		<a class="linkedin" href="http://www.linkedin.com/in/brandonhilkert">LinkedIn</a>
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
</nav>
<!-- Begin MailChimp Signup Form -->
<div class="newsletter-form">
  <h3>Email Updates</h3>
  <form action="http://brandonhilkert.us7.list-manage2.com/subscribe/post?u=34ccc3aa2135746d0231c9420&amp;id=167c8d9713" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email" required>
    <br class="clear">
    <input type="hidden" name="SIGNUP" id="SIGNUP" value="nav" />
    <input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button">
    <br class="clear">
  </form>
</div>
<!--End mc_embed_signup-->


</header>
		</div>
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner"><article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <div class="date">








  


<time datetime="2013-10-20T16:41:00-04:00" data-updated="true" itemprop="datePublished">October 20<span>th</span>, 2013</time></div>
	<h1 class="title" itemprop="name">Why I Wrote Sucker_punch</h1>
  <div class="tags">


	<a class='category' href='/blog/categories/open-source/'>open source</a>, <a class='category' href='/blog/categories/programming/'>programming</a>, <a class='category' href='/blog/categories/ruby/'>ruby</a>


</div>
	<div class="entry-content" itemprop="articleBody"><p>One of the simplest and most common application of
background processing is sending emails outside of a web
request. And while background processing is pretty
common, Ruby libraries require an additional background
process to execute jobs. The application I was working on
was hosted on Heroku, and the cost of adding an
additional dyno is $35/month. The background jobs did
very little more than send emails the current solutions
seemed like overkill to me. So
<a href="https://github.com/brandonhilkert/sucker_punch">sucker_punch</a>
was born&hellip;</p>

<h3>Ruby Background Processing Libraries</h3>

<p>Until I had heard of Sidekiq,
<a href="https://github.com/collectiveidea/delayed_job/tree/master">delayed_job</a>
and <a href="https://github.com/resque/resque">Resque</a> were the
standard options for processing background jobs in Ruby.
I&rsquo;ve used both and believe each has a great use case.</p>

<p>My experience is that it&rsquo;s easiest to start with
delayed_job and if you get to the point where the DB is
your bottleneck, it&rsquo;s time to move on. Redis is a
dependency of both Resque and Sidekiq, so it requires
more infrastructure and care to maintain, however, with
<a href="https://addons.heroku.com/?q=redis">Heroku&rsquo;s hosted Redis
Add-ons</a>, this
dependency is much less of a pain any more.</p>

<h3>My work on Sidekiq</h3>

<p>I previously wrote about my my <a href="http://brandonhilkert.com/blog/3-ways-to-get-started-contributing-to-open-source/">open source
contributions</a>
and how I got started. I had spent the previous several
months contributing to Sidekiq and learning more about
concurrency patterns in Ruby.</p>

<p>Sidekiq is multi-threaded, which is the reason a single
Sidekiq process is <a href="https://github.com/mperham/sidekiq/wiki/Testimonials">more
efficient</a>.
However, care must be taken to ensure your jobs are
thread-safe. A helpful <a href="https://github.com/mperham/sidekiq/wiki/Best-Practices">guide to writing thread-safe
code</a>
can be found on the Sidekiq wiki.</p>

<h3>My Use Case</h3>

<p>I was working on <a href="http://defriendnotifierapp.com/">Defriend
Notifier</a> and needed to
notify users via email when their Facebook friend list
changed. Using Sidekiq or any of the alternatives
mentioned above would have worked for my use. In fact,
the application originally did use Sidekiq and worked
perfectly. However, I was looking for ways to reduce the
hosting cost of the application given that it doesn&rsquo;t
produce any revenue stream outside of advertising.</p>

<p>The only background processing library that doesn&rsquo;t
require an additional background process is
<a href="https://github.com/mperham/girl_friday">girl_friday</a>,
also written by <a href="https://twitter.com/mperham">Mike
Perham</a>, author of Sidekiq.
While this solution worked for awhile, I found the syntax
to be slightly non-intuitive and it felt a little dirty
to pass around a global variable within the application
to manage a single job queue. I also experienced some
memory leaks on Heroku as a result of switching to
girl_friday, but to be fair, I didn&rsquo;t spend much time
determining the root cause. It&rsquo;s very likely it could
have been code that I wrote.</p>

<h3>Celluloid</h3>

<p><a href="https://github.com/celluloid/celluloid">Celluloid</a>
describes itself as an actor-based concurrent object
framework for Ruby. Celluloid is the guts behind Sidekiq
and the reason why the multi-threaded Sidekiq code is so
readable. Celluloid abstracts away the details of
concurrency so that the library code doesn&rsquo;t have to
worry about manually managing thread synchronization and
object message queuing.</p>

<h3>sucker_punch is born</h3>

<p>girl_friday was written several years previous, before
Celluloid was created. Realizing the power of Celluloid,
I figured there was an opportunity for a new library that
essentially behaved like girl_friday, but utilized
Celluloid&rsquo;s more reliable multi-threading capabilities.</p>

<p>I <a href="https://twitter.com/brandonhilkert/status/292630123981729793">tweeted at Mike
Perham</a>
and his response was enough to affirm my interest.</p>

<p>Fortunately, Celluloid had all of the functionality
needed for background queues already built-in. While the
functionality was there, the usage syntax was a little
awkward given that it wasn&rsquo;t primary usage for the
framework.</p>

<p>I spent the next few days creating a DSL around the
Celluloid internals, thus making it feel more specific to
background queues.</p>

<p>Here is a typical job class:</p>

<figure class='code'><figcaption><span>Example sucker_punch job class</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">LogJob</span>
</span><span class='line'>  <span class="kp">include</span> <span class="ss">SuckerPunch</span><span class="p">:</span><span class="ss">:Job</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">perform</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</span><span class='line'>    <span class="c1"># do some other stuff to</span>
</span><span class='line'>    <span class="c1"># record the event in the background</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">event</span><span class="si">}</span><span class="s2"> just happened&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>I deployed the sucker_punch-converted code to production
and gave it a week or so before I declared it a success.
Once I realized sucker_punch was going to be a
maintainable method for processing background jobs in a
single web process, I added additional niceties like
logging and queue configuration details that may be
valuable for other use cases.</p>

<p>Have you tried sucker_punch yet? If so, I&rsquo;d love to know how it went and what you used it for&hellip;</p>
</div>
  <section class="newsletter">
  <h3>
    Like this post?
    <br />
    Signup below to receive updates by email
  </h3>
  <form action="http://brandonhilkert.us7.list-manage2.com/subscribe/post?u=34ccc3aa2135746d0231c9420&amp;id=167c8d9713" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email" required>
    <br class="clear">
    <input type="hidden" name="SIGNUP" id="SIGNUP" value="Why I Wrote sucker_punch" />
    <input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button">
    <br class="clear">
  </form>
  <aside>
    I hate spam as much as you do!
    <br />
    Unsubscribe at any time.
  </aside>
</section>



</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">

	
  <a href="http://bufferapp.com/add" class="buffer-add-button" data-count="horizontal" data-via="brandonhilkert" >Buffer</a>
  <script type="text/javascript" src="http://static.bufferapp.com/js/button.js"></script>
	

	
	<a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
	

	
	<a class="addthis_button_tweet"></a>
	

	
  <script type="IN/Share" data-counter="right"></script>
	

	
	<a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
	

	<!-- <a class="addthis_counter addthis_pill_style"></a> -->
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>



<section id="comment">
    <h1 class="title">Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>
</div>
			</div>
			<footer id="footer" class="inner"><p>
  Copyright &copy; 2013 - Brandon Hilkert
</p>
</footer>
			<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'brandonhilkert';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://brandonhilkert.com/blog/why-i-wrote-sucker-punch/';
        var disqus_url = 'http://brandonhilkert.com/blog/why-i-wrote-sucker-punch/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-24469169-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-24469169-2', 'brandonhilkert.com');
    ga('send', 'pageview');
  </script>



		</div>
	</div>
</body>
</html>
