
<!DOCTYPE HTML>
<html xmlns:og="http://ogp.me/ns#" xmlns:fb="http://ogp.me/ns/fb#">
<head>
	<meta charset="utf-8">
	
	
	
  
  
  <title>Using the Sucker Punch Ruby Gem to Cache Stripe Data in Rails | Brandon Hilkert</title>
	<meta name="author" content="Brandon Hilkert">

	<meta name="description" content="February 26th, 2015 Using the Sucker Punch Ruby Gem to Cache Stripe Data in Rails open source, rails, ruby, sucker punch *** Free screencast below *** With so &hellip;">
	

  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimal-ui">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:creator" content="@brandonhilkert">
  <meta name="twitter:title" content="Using the Sucker Punch Ruby Gem to Cache Stripe Data in Rails">
  <meta name="twitter:description" content="February 26th, 2015 Using the Sucker Punch Ruby Gem to Cache Stripe Data in Rails open source, rails, ruby, sucker punch *** Free screencast below *** With so many services available these days, it& &hellip;">
  <meta name="twitter:image" content="http://brandonhilkert.com/images/brandon-hilkert.jpg">

  <meta property="og:title" content="Using the Sucker Punch Ruby Gem to Cache Stripe Data in Rails | Brandon Hilkert"/>
  <meta property="og:description" content="February 26th, 2015 Using the Sucker Punch Ruby Gem to Cache Stripe Data in Rails open source, rails, ruby, sucker punch *** Free screencast below *** With so many services available these days, it& &hellip;">
  <meta property="og:url" content="http://brandonhilkert.com/blog/using-the-sucker-punch-ruby-gem-to-cache-stripe-data-in-rails/"/>
  <meta property="og:image" content="http://brandonhilkert.com/images/brandon-hilkert-large.jpg" />
  <meta property="og:site_name" content="Brandon Hilkert's Blog"/>
  <meta property="og:type" content="article"/>
  <meta property="fb:profile_id" content="1472745932"/>

	<link href="/atom.xml" rel="alternate" title="Using the Sucker Punch Ruby Gem to Cache Stripe Data in Rails | Brandon Hilkert" type="application/atom+xml">
	<link rel="canonical" href="http://brandonhilkert.com/blog/using-the-sucker-punch-ruby-gem-to-cache-stripe-data-in-rails/">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
  <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <link href="//fonts.googleapis.com/css?family=Open+Sans:300" rel="stylesheet" type="text/css">
  <link rel="author" href="https://plus.google.com/u/0/116002935339410846674" />
  <script src="/javascripts/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-24469169-1', 'auto');
  ga('require', 'linkid', 'linkid.js');
  ga('require', 'displayfeatures');
  ga('send', 'pageview');
</script>

</head>


<body>
	<div class="container">
		<div class="left-col">
			<header id="header"><div class="profilepic">
  <a href="/">
    <img src="/images/brandon-hilkert.jpg" width="80" height="80" alt="Brandon Hilkert Profile Picture" />
  </a>
</div>
<hgroup>
  <h1><a href="/">Brandon Hilkert</a></h1>
  
</hgroup>

<nav id="main-nav">
  <ul class="main-navigation">
    <li><a href="/about/">About</a></li>
    <li><a href="/">Blog</a></li>
    <li><a href="/newsletter/">Newsletter</a></li>
    <!-- <li> -->
    <!--   <a href="/courses/build&#45;a&#45;ruby&#45;gem/">Courses</a> -->
    <!-- </li> -->
    <li>
      <div class="new-label">New</div>
      <a href="/books/build-a-ruby-gem/">Books</a>
    </li>
    <li>
      <a href="/talks/">Talks</a>
    </li>
    <!-- <li> -->
    <!--   <a href="/tools/">Tools</a> -->
    <!-- </li> -->
  </ul>
</nav>

<nav id="sub-nav">
	<div class="social">
		
		
		
		<a class="twitter" href="https://twitter.com/brandonhilkert" title="Twitter">Twitter</a>
		
		
		<a class="github" href="https://github.com/brandonhilkert" title="GitHub">GitHub</a>
		
		
		<a class="linkedin" href="http://www.linkedin.com/in/brandonhilkert">LinkedIn</a>
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
</nav>

<aside class="popular-posts">
  <h4>Popular Posts</h4>
<ul>
  <li>
    <a href="/blog/7-reasons-why-im-sticking-with-minitest-and-fixtures-in-rails/">7 Reasons I'm sticking with Minitest</a>
  </li>
  <li>
    <a href="/blog/organizing-javascript-in-rails-application-with-turbolinks/">Organizing JS in Rails w/ Turbolinks</a>
  </li>
  <li>
    <a href="/blog/using-rails-4-dot-1-secrets-for-configuration/">Using Rails 4 Secrets for Config</a>
  </li>
  <li>
    <a href="/blog/using-rails-fixtures-to-seed-a-database/">Using Fixtures to Seed a Database</a>
  </li>
  <li>
    <a href="/blog/ruby-gem-configuration-patterns/">Ruby Gem Configuration Patterns</a>
  </li>
  <!-- <li> -->
  <!--   <a href="/blog/how&#45;to&#45;build&#45;a&#45;rails&#45;engine/">How to Build a Rails Engine</a> -->
  <!-- </li> -->
  <!-- <li> -->
  <!--   <a href="/blog/why&#45;i&#45;wrote&#45;the&#45;sucker&#45;punch&#45;gem/">Why I Wrote the Sucker Punch Gem</a> -->
  <!-- </li> -->
  <!-- <li> -->
  <!--   <a href="/blog/setting&#45;up&#45;a&#45;cloudfront&#45;cdn&#45;for&#45;rails/">Setup a Cloudfront CDN for Rails</a> -->
  <!-- </li> -->
  <!-- <li> -->
  <!--   <a href="/blog/3&#45;ways&#45;to&#45;get&#45;started&#45;contributing&#45;to&#45;open&#45;source/">Get Started with Open Source</a> -->
  <!-- </li> -->
</ul>


</aside>

</header>
		</div>
		<div class="mid-col">
			<div class="mid-col-container">
				<div id="content" class="inner"><article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  
  <div class="date">








  


<time datetime="2015-02-26T20:46:00-08:00" data-updated="true" itemprop="datePublished">February 26<span>th</span>, 2015</time></div>
	<h1 class="title" itemprop="name">Using the Sucker Punch Ruby Gem to Cache Stripe Data in Rails</h1>
  <div class="tags">


	<a class='category' href='/blog/categories/open-source/'>open source</a>, <a class='category' href='/blog/categories/rails/'>rails</a>, <a class='category' href='/blog/categories/ruby/'>ruby</a>, <a class='category' href='/blog/categories/sucker-punch/'>sucker punch</a>


</div>
	<div class="entry-content" itemprop="articleBody">
    
      <p><strong><a href="#bonus">*** Free screencast below ***</a></strong></p>
    

    <p>With so many services available these days, it&rsquo;s almost impossible to find or build an application that doesn&rsquo;t rely on a third-party service. Most developers that have dealt with billing systems within the past few years have likely heard of <a href="https://stripe.com/">Stripe</a>. Stripe is, by far, the most developer-friendly billing service I&rsquo;ve implemented.</p>

<p>While Stripe does provide a number of features and plugins that make updating a credit card or signing up for a service simple, there are occasions when data needs to be fetched from Stripe in real-time. For these cases, it&rsquo;s great to be able to fetch and cache this data before-hand, and only expire if you know there&rsquo;s been a change.</p>

<!--more-->


<p>Combining <a href="https://github.com/brandonhilkert/sucker_punch">Sucker Punch</a> with Rails cache allows you to cache Stripe customer data so that billing pages are just as snappy as the rest of the application.</p>

<h2>The Pain</h2>

<p>Even though Stripe is generally pretty fast, retrieving customer data on the fly can be expensive. In order to optimize page load times, we can look to cache this data before it&rsquo;s actually used.</p>

<p>If you&rsquo;re familiary with the Stripe gem, you&rsquo;ve probably seen something like this:</p>

<figure class='code'><pre><code>customer = Stripe::Customer.retrieve(user.stripe_id)</code></pre></figure>


<p>With the response of <code>customer</code>, we can further query customer data with the following methods:</p>

<figure class='code'><pre><code>invoices = customer.invoices
upcoming_invoices = customer.upcoming_invoices</code></pre></figure>


<p>If we make all 3 of these method calls on page load, we&rsquo;d have 3 separate lookups from Stripe. This is pretty common for the typical billing page where you might want to show the customer&rsquo;s current credit card on file, their past invoices, and charges they can expect for the next invoice.</p>

<p>Three lookups like this could potentially add another second or so to page load, which is not ideal.</p>

<p>So how can we improve this?</p>

<h2>The Solution</h2>

<p>First, we can move the code to fetch the relevant stripe data in to a class of it&rsquo;s own, which wraps the notion of caching around the data retrieval.</p>

<figure class='code'><pre><code>class StripeCache
  def initialize(user)
    @user = user
  end

  def refresh
    purge_all
    cache_all
    self
  end

  def customer
    return @customer if @customer

    @customer = Rails.cache.fetch(cache_key("customer"), expires_in: 15.minutes) do
      Stripe::Customer.retrieve(user.stripe_id)
    end
  end

  def invoices
    Rails.cache.fetch(cache_key("invoices"), expires_in: 15.minutes) do
      customer.invoices
    end
  end

  def upcoming_invoice
    Rails.cache.fetch(cache_key("upcoming_invoice"), expires_in: 15.minutes) do
      customer.upcoming_invoice
    end
  end

  private

  attr_reader :user

  def cache_all
    customer
    invoices
    upcoming_invoice
  end

  def purge_all
    Rails.cache.delete_matched("#{user.id}/stripe")
  end


  def cache_key(item)
    "user/#{user.id}/stripe/#{item}"
  end
end</code></pre></figure>


<p>To use this on a billing page, we could do:</p>

<figure class='code'><pre><code>stripe = StripeCache.new(current_user).refresh</code></pre></figure>


<p>And from the response of that class, we could access the <code>customer</code>, <code>invoices</code>, and <code>upcoming_invoice</code> respectively:</p>

<figure class='code'><pre><code>@customer = stripe.customer
@invoices = stripe.invoices
@upcoming_invoice = stripe.invoices</code></pre></figure>


<p>This is great! All future calls to this customer&rsquo;s Stripe data will be fast &mdash; for 15 minutes, of course.</p>

<p>However, the first time the page is load, the user is still burdened with the initial fetch of the data. So the method above works for every request to the billing page after the first.</p>

<p>But let&rsquo;s be honest, what users are going to the billing page multiple times during a session? Probably not many. So we still need to fix the initial load somehow.</p>

<p>This is where <a href="https://github.com/brandonhilkert/sucker_punch">Sucker Punch</a> comes in. Like other Ruby background processing libraries, Sucker Punch allows you to move the processing of code to the background. However, unlike the others, Sucker Punch doesn&rsquo;t require additional infrastructure like Redis, and doesn&rsquo;t require a separate worker process to monitor and execute enqueued jobs. Because of this, the time it takes to extract code to a Sucker Punch job and have it incorporated with your application code is much lower.</p>

<p>In this case, rather than send a transactional email or perform some database calculation, we can write a job thats only responsibility is to run the Stripe caching code.</p>

<figure class='code'><pre><code>class StripeCacheJob
  include SuckerPunch::Job

  def perform(user)
    StripeCache.new(user).refresh
  end
end</code></pre></figure>


<p>The next question is, when do you run this?</p>

<p>Well, I chose to run it on user login, but you could run it anywhere you think would give you a head start if the user were about to go to the billing page. In my case, on login meant that if they didn&rsquo;t go to the billing page at all, after 15 minutes the data would be exhausted from the cache anyway, so no hard done.</p>

<p>But if the user did navigate to the billing page during that session, they would have up the latest Stripe customer and invoice data to see &mdash; all without a request to stripe on page load.</p>

<p>One other thing to keep in mind is there may be times when we&rsquo;d want invalidate the Rails cache data. One example would be when the user&rsquo;s card information is updated. In that case, we can slip in another call to the Stripe cache job, which would invalidate the previous cache and re-request the customer&rsquo;s billing information:</p>

<figure class='code'><pre><code>module Accounts
  class CardsController &lt; ApplicationController
    before_action :require_authentication

    def create
      cust = StripeCache.new(current_user).customer
      cust.save(card: params[:stripeToken])

      StripeCacheJob.new.async.perform(current_user)

      redirect_to account_path, notice: t("card.update.success")
    end
  end
end</code></pre></figure>


<h2>Summary</h2>

<p>Using Sucker Punch in combination with Rails cache feels like a great way make optimizations to third-party data requests. This article focused on using it to fetch Stripe data, but it could be used with another service just as easily.</p>

<p>The beauty of Sucker Punch is that it doesn&rsquo;t require a separate worker process to be running in the background. On a platform like Heroku, this saves the cost of an additional dyno.</p>

<p>Sucker Punch excels at background jobs that are relatively fast and if missed,
wouldn&rsquo;t be critical to the operation. In this case, if a cache job is lost,
it&rsquo;s not the end of the world. At worst, the user&rsquo;s Stripe data would be requested on the fly and the page would be slower than usual. But the majority of the time, the request is fast because the data&rsquo;s been cached beforehand.</p>

<p>What other jobs have you used Sucker Punch for?</p>

  </div>

  

  
    <section class="newsletter-top">
  <img src="/images/newsletter/brandon-hilkert-point-down.png" alt="Brandon Hilkert pointing down">
</section>
<section class="newsletter clearfix" id="bonus">
  <div class="ribbon">
    <span>
      Join 4,000+ Rubyists
    </span>
  </div>
  <section class="picture screencast">
    <img src="/images/newsletter/screencast.png" alt="Brandon Hilkert screencast">
  </section>
  <section class="signup">
    <h2>Watch a FREE Screencast</h2>
    <h3>
      Detailed walkthrough implementing
      <br />
      Sucker Punch to cache Stripe data
    </h3>

    <form data-drip-embedded-form="9892422" action="https://www.getdrip.com/forms/9892422/submissions" method="post">
  <div class="email-input-container">
    <input type="email" value="" name="fields[email]" class="email" placeholder="your@email.com" required>
  </div>
  <input type="hidden" name="fields[location]" value="Using the Sucker Punch Ruby Gem to Cache Stripe Data in Rails" />
  <div style="display: none;" aria-hidden="true">
    <label for="website">Website</label><br />
    <input type="text" id="website" name="website" tabindex="-1" autocomplete="false" value="" />
  </div>
  <input type="submit" value="Send me the FREE screencast!" name="subscribe" class="button">
  <br class="clear">
</form>



  </section>
</section>


  


</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">

    
    <a href="http://bufferapp.com/add" class="buffer-add-button" data-count="horizontal" data-via="brandonhilkert" >Buffer</a>
    <script type="text/javascript" src="https://static.bufferapp.com/js/button.js"></script>
    

    
    <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
    

    
    <a class="addthis_button_tweet"></a>
    

    
    <script type="IN/Share" data-counter="right"></script>
    

    
    <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    

	</div>
  <script type="text/javascript" src="https://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>



</div>
			</div>
      
        <footer id="footer" class="inner"><ul>
  <li>
    <h4>Categories</h4>
    <ul>
      <li><a href="/blog/categories/ruby/">Ruby</a></li>
      <li><a href="/blog/categories/rails/">Rails</a></li>
      <li><a href="/blog/categories/open-source/">Open Source</a></li>
      <li><a href="/blog/categories/marketing/">Marketing</a></li>
      <li><a href="/blog/categories/email-course/">Email Course</a></li>
      <li><a href="/blog/categories/book/">Book</a></li>
    </ul>
  </li>
  <li>
    <h4>Popular Posts</h4>
<ul>
  <li>
    <a href="/blog/7-reasons-why-im-sticking-with-minitest-and-fixtures-in-rails/">7 Reasons I'm sticking with Minitest</a>
  </li>
  <li>
    <a href="/blog/organizing-javascript-in-rails-application-with-turbolinks/">Organizing JS in Rails w/ Turbolinks</a>
  </li>
  <li>
    <a href="/blog/using-rails-4-dot-1-secrets-for-configuration/">Using Rails 4 Secrets for Config</a>
  </li>
  <li>
    <a href="/blog/using-rails-fixtures-to-seed-a-database/">Using Fixtures to Seed a Database</a>
  </li>
  <li>
    <a href="/blog/ruby-gem-configuration-patterns/">Ruby Gem Configuration Patterns</a>
  </li>
  <!-- <li> -->
  <!--   <a href="/blog/how&#45;to&#45;build&#45;a&#45;rails&#45;engine/">How to Build a Rails Engine</a> -->
  <!-- </li> -->
  <!-- <li> -->
  <!--   <a href="/blog/why&#45;i&#45;wrote&#45;the&#45;sucker&#45;punch&#45;gem/">Why I Wrote the Sucker Punch Gem</a> -->
  <!-- </li> -->
  <!-- <li> -->
  <!--   <a href="/blog/setting&#45;up&#45;a&#45;cloudfront&#45;cdn&#45;for&#45;rails/">Setup a Cloudfront CDN for Rails</a> -->
  <!-- </li> -->
  <!-- <li> -->
  <!--   <a href="/blog/3&#45;ways&#45;to&#45;get&#45;started&#45;contributing&#45;to&#45;open&#45;source/">Get Started with Open Source</a> -->
  <!-- </li> -->
</ul>


  </li>
</ul>
<br class="clear" />
<p>
  &copy; 2019 Big Blue Media, LLC. All rights reserved.
</p>
</footer>
        <script src="/javascripts/slash.js"></script>




      
		</div>
	</div>
  <link href="/stylesheets/funnel-tools-capture.css" media="screen, projection" rel="stylesheet" type="text/css">

<div id="funnel-tools-capture" class="bounceInUp">
  <div class="close">&#10005;</div>
  <div class="open">&#8593;</div>

  <div class="title">
    Build a Ruby Gem Course - FREE!
  </div>
  <div class="description">
    <p>
      Join <strong>1,300+</strong> other Rubyists and take your Ruby gem skills to the next level!
    </p>
    <p>
      Whether you're an expert Rubyist, or just starting out,
      this <strong>FREE 10-day</strong> email course will guide you through
      the process of creating your own Ruby gems from start to finish.
    </p>

    <p>
      Enter your email below to get started today:
    </p>
  </div>

  <form data-drip-embedded-form="8461781" action="https://www.getdrip.com/forms/8461781/submissions" method="post">
  <div class="email-input-container">
    <input type="email" value="" name="fields[email]" class="email" placeholder="your@email.com" required>
  </div>
  <input type="hidden" name="fields[location]" value="Using the Sucker Punch Ruby Gem to Cache Stripe Data in Rails" />
  <div style="display: none;" aria-hidden="true">
    <label for="website">Website</label><br />
    <input type="text" id="website" name="website" tabindex="-1" autocomplete="false" value="" />
  </div>
  <input type="submit" value="I want the FREE course!" name="subscribe" class="button">
  <br class="clear">
</form>


  <p class="funnel-tools-footer">
  Powered by <a href="http://brandonhilkert.com/tools?utm_source=bh-com&utm_medium=web&utm_campaign=ft-capture">Funnel Tools</a>
</p>

</div>


<script src="/javascripts/funnel-tools-capture.min.js"></script>


  <!-- Drip -->
<script type="text/javascript">
  var _dcq = _dcq || [];
  var _dcs = _dcs || {};
  _dcs.account = '7901432';

  (function() {
    var dc = document.createElement('script');
    dc.type = 'text/javascript'; dc.async = true;
    dc.src = '//tag.getdrip.com/7901432.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(dc, s);
  })();
</script>

</body>
</html>
